name: Process arXiv Papers with Poke API

# Trigger on manual workflow dispatch or on push to papers directory
on:
  workflow_dispatch:
    inputs:
      paper_file:
        description: 'Path to paper JSON file'
        required: true
        type: string
        default: 'papers/latest.json'
      arxiv_id:
        description: 'arXiv ID (optional)'
        required: false
        type: string
  
  push:
    paths:
      - 'papers/**/*.json'

jobs:
  process-papers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Process paper with Poke API
        id: process
        env:
          POKE_API_KEY: ${{ secrets.POKE_API_KEY }}
          POKE_API_BASE_URL: ${{ secrets.POKE_API_BASE_URL }}
          POKE_API_ENABLED: 'true'
        run: |
          PAPER_FILE="${{ github.event.inputs.paper_file || 'papers/latest.json' }}"
          
          if [ -f "$PAPER_FILE" ]; then
            python scripts/process_paper_with_poke.py \\
              "$PAPER_FILE" \\
              --send-to-poke \\
              ${{ github.event.inputs.arxiv_id && format('--arxiv-id {0}', github.event.inputs.arxiv_id) || '' }} \\
              --output processed_output.json
          else
            echo "Error: Paper file not found: $PAPER_FILE"
            exit 1
          fi
      
      - name: Upload processed output
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: processed-paper-insights
          path: processed_output.json
          retention-days: 30
      
      - name: Create summary
        if: always()
        run: |
          echo "### Paper Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Paper File**: ${{ github.event.inputs.paper_file || 'papers/latest.json' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **arXiv ID**: ${{ github.event.inputs.arxiv_id || 'Auto-detected' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Poke API**: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.process.outcome }}" == "success" ]; then
            echo "âœ… Processing completed successfully!" >> $GITHUB_STEP_SUMMARY
            
            # Show metrics if available
            if [ -f "processed_output.json" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Processed Data" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              head -n 20 processed_output.json >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Processing failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Post-processing notification
        if: success()
        run: |
          echo "âœ… Paper successfully processed and sent to Poke API"
          echo "ðŸ“Š Check the artifacts for detailed output"
